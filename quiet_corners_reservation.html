<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Quiet Corners — Reservation</title>
  <style>
    body{font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial; margin:0; padding:20px; background:#f7fafc;}
    .app{max-width:900px; margin:0 auto; background:#fff; padding:18px; border-radius:10px; box-shadow:0 6px 18px rgba(20,20,30,0.08);}
    header{display:flex; align-items:center; gap:12px; margin-bottom:12px;}
    h1{margin:0; font-size:20px;}
    p.lead{margin:0; color:#4b5563;}
    .controls{display:flex; gap:8px; margin:12px 0; flex-wrap:wrap;}
    select,input[type=date]{padding:8px; border-radius:6px; border:1px solid #d1d5db;}
    button{padding:8px 12px; border-radius:8px; border:0; background:#0ea5a3; color:white; cursor:pointer;}
    button.secondary{background:#64748b;}
    .grid{display:grid; grid-template-columns:1fr 1fr; gap:16px;}
    @media(max-width:700px){.grid{grid-template-columns:1fr}}
    .card{padding:12px; border:1px solid #e6e9ef; border-radius:8px;}
    table{width:100%; border-collapse:collapse;}
    th,td{padding:8px; text-align:left; border-bottom:1px solid #f1f5f9;}
    .slot.free{background:#ecfdf5; color:#166534; padding:6px 8px; border-radius:6px; display:inline-block;}
    .slot.taken{background:#fff1f2; color:#991b1b; padding:6px 8px; border-radius:6px; display:inline-block;}
    .small{font-size:13px; color:#6b7280;}
    .notice{background:#fef3c7; padding:8px; border-radius:6px;}
    .actions{display:flex; gap:8px; margin-top:8px;}
    .exportarea{width:100%; height:90px;}
  </style>
</head>
<body>
  <div class="app">
    <header>
      <div>
        <h1>Quiet Corners — Reservation</h1>
        <p class="lead">Simple, offline-friendly reservation board for campus study spaces. Works entirely in your browser.</p>
      </div>
    </header>

    <div class="controls">
      <label>Date: <input id="date" type="date" value= + today_iso + ></label>
      <label>Time slot: <select id="timeslot">
        <option value="08:00">08:00 - 09:00</option>
        <option value="09:00">09:00 - 10:00</option>
        <option value="10:00">10:00 - 11:00</option>
        <option value="11:00">11:00 - 12:00</option>
        <option value="12:00">12:00 - 13:00</option>
        <option value="13:00">13:00 - 14:00</option>
        <option value="14:00">14:00 - 15:00</option>
        <option value="15:00">15:00 - 16:00</option>
        <option value="16:00">16:00 - 17:00</option>
        <option value="17:00">17:00 - 18:00</option>
      </select></label>
      <label>Space: <select id="space">
        <option>Rm 202 Hallway Corner</option>
        <option>Rm 105 Table</option>
        <option>Library Study Room A</option>
        <option>Rm 312 Small Classroom</option>
        <option>Library Quiet Nook</option>
      </select></label>

      <input id="name" type="text" placeholder="Your name (optional)" style="padding:8px; border-radius:6px; border:1px solid #d1d5db;">
      <button id="reserveBtn">Reserve</button>
      <button id="cancelBtn" class="secondary">Cancel My Reservation</button>
    </div>

    <div class="grid">
      <div class="card">
        <h3>Today's schedule</h3>
        <div id="scheduleArea"></div>
        <p class="small">Green = free. Red = reserved. Click a reserved slot to see owner.</p>
      </div>

      <div class="card">
        <h3>Share / Backup</h3>
        <p class="small">Export reservations (JSON) to share the current board with others or to import on another device.</p>
        <div class="actions">
          <button id="exportBtn" class="secondary">Export JSON</button>
          <button id="importBtn" class="secondary">Import JSON</button>
        </div>
        <textarea id="importArea" class="exportarea" placeholder="Paste exported JSON here to import"></textarea>

        <h4 style="margin-top:12px">Quick rules</h4>
        <ul class="small">
          <li>Max 2-hour continuous booking per person.</li>
          <li>Be on time — cancel if you can't make it.</li>
          <li>Keep quiet in "Quiet Nook" zones.</li>
        </ul>
      </div>
    </div>

    <div style="margin-top:12px" class="notice small">
      Tip: This file works offline. To make it available campus-wide, upload the file to your student org's website or GitHub Pages and create a QR code that links to the hosted URL.
    </div>
  </div>

<script>
const spaces = Array.from(document.querySelectorAll('#space option')).map(o=>o.textContent);
const times = Array.from(document.querySelectorAll('#timeslot option')).map(o=>o.value);

const dateInput = document.getElementById('date');
const nameInput = document.getElementById('name');
const spaceSelect = document.getElementById('space');
const timeslotSelect = document.getElementById('timeslot');
const reserveBtn = document.getElementById('reserveBtn');
const cancelBtn = document.getElementById('cancelBtn');
const scheduleArea = document.getElementById('scheduleArea');
const exportBtn = document.getElementById('exportBtn');
const importBtn = document.getElementById('importBtn');
const importArea = document.getElementById('importArea');

// localStorage key
const KEY = 'quiet_corners_reservations_v1';

function loadData(){
  const raw = localStorage.getItem(KEY);
  return raw ? JSON.parse(raw) : {};
}
function saveData(data){
  localStorage.setItem(KEY, JSON.stringify(data));
}

function getDayKey(dt){
  return dt;
}

function renderSchedule(){
  const data = loadData();
  const day = getDayKey(dateInput.value);
  const dayData = data[day] || {};
  // Build table
  let html = '<table><thead><tr><th>Space / Time</th>';
  times.forEach(t=> html += `<th>${t}</th>`);
  html += '</tr></thead><tbody>';
  spaces.forEach(sp => {
    html += `<tr><td><strong>${sp}</strong></td>`;
    times.forEach(t => {
      const cellKey = sp + '||' + t;
      const owner = dayData[cellKey];
      if(owner){
        html += `<td><div class="slot taken" data-key="${cellKey}" data-owner="${owner}">RESERVED</div></td>`;
      } else {
        html += `<td><div class="slot free" data-key="${cellKey}">FREE</div></td>`;
      }
    });
    html += '</tr>';
  });
  html += '</tbody></table>';
  scheduleArea.innerHTML = html;

  // add click handlers to reserved slots to show owner
  document.querySelectorAll('.slot.taken').forEach(el => {
    el.addEventListener('click', ()=>{
      alert('Reserved by: ' + el.dataset.owner);
    });
  });
}

function reserve(){
  const who = nameInput.value.trim() || 'Anonymous';
  const day = getDayKey(dateInput.value);
  const space = spaceSelect.value;
  const time = timeslotSelect.value;
  const key = space + '||' + time;
  const data = loadData();
  data[day] = data[day] || {};

  // enforce simple rule: no double-booking and max 2-hour rule per person (count slots for person)
  if(data[day][key]){
    alert('That slot is already reserved.');
    return;
  }
  // count existing slots reserved by this person on the same day.
  const reservedByPerson = Object.values(data[day]).filter(v=>v===who).length;
  if(reservedByPerson >= 2){
    if(!confirm('You already have 2 bookings today. Continue?')) return;
  }

  data[day][key] = who;
  saveData(data);
  renderSchedule();
}

function cancelReservation(){
  const who = nameInput.value.trim() || prompt('Enter name used to reserve (or leave blank for Anonymous):') || 'Anonymous';
  const day = getDayKey(dateInput.value);
  const space = spaceSelect.value;
  const time = timeslotSelect.value;
  const key = space + '||' + time;
  const data = loadData();
  if(!data[day] || !data[day][key]){
    alert('No reservation found for that slot.');
    return;
  }
  if(data[day][key] !== who && who !== 'Anonymous'){
    if(!confirm('Reservation was made by "'+data[day][key]+'". Do you still want to remove it?')){
      return;
    }
  }
  delete data[day][key];
  saveData(data);
  renderSchedule();
}

// export / import
exportBtn.addEventListener('click', ()=>{
  const data = loadData();
  const blob = new Blob([JSON.stringify(data, null, 2)], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'quiet_corners_reservations.json';
  a.click();
  URL.revokeObjectURL(url);
});

importBtn.addEventListener('click', ()=>{
  try{
    const parsed = JSON.parse(importArea.value.trim());
    if(!confirm('Importing will overwrite your local reservations. Continue?')) return;
    saveData(parsed);
    renderSchedule();
    alert('Imported successfully.');
  }catch(e){
    alert('Invalid JSON. Please paste JSON exported from the Export button.');
  }
});

reserveBtn.addEventListener('click', reserve);
cancelBtn.addEventListener('click', cancelReservation);
dateInput.addEventListener('change', renderSchedule);

// initialize
if(!dateInput.value){
  const today = new Date().toISOString().slice(0,10);
  dateInput.value = today;
}
renderSchedule();
</script>
</body>
</html>
